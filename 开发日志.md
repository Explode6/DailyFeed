## 4.21

学习使用**网络技术**，从订阅源网址下载xml

​	使用的主要技术：**OkHttp**

进展：成功使用OkHttp从订阅网址下载到了xml文件



##4.22

学习安桌数据持久化技术

​	使用的主要技术有：SharedPreference（键值对），SQLite

​	需求：

​		1.解析的HTML直接存放到==SQLite==数据库   

​		2.需要用到的数据信息：频道（标题，图片，推送日期，简介），文章（标题，原文链接，作者，==时间==，类别，简介，==内容==，本地评论）

​		3.文章按日保存，需要==去重==，以最新发布的为准(增量更新)

​		4.收藏的文章另建新表

## 4.23

学习使用开源库LitePal对数据进行CRDU（ORM映射）

设计数据库:

Channel:  (

**int id[p_key]**,  

String title, 

**``String rssLink[unique, index]``**, 

String addressLink,

long lastBuildDate, 

String description, 

Image image[nullable=true] 

)



ArticleBrief:  ( 

**int id[p_key]**, 

String title, 

**``String link[unique, index]``**, 

String creator, 

**long pubDate**, 

String[] Category, 

String description, 

Boolean isRead,

**int channel_id[f_key]**

**int content_id[f_key]**

)



ArticleContent:{

**int id[p_key]**, 

String content;

}



Collection(

**int id[p_key]**, 

String title, 

**``String link[unique]``**, 

String creator, 

String[] Category, 

String description, 

String content

)



## 4.24

工作进展：创建了数据库，并完成了数据增删查改基本接口的封装，对数据库的表格进行部分优化。

逻辑结构：频道表，文章简介表，文章内容表，收藏文章表



## 4.25

工作进展：学习了WebView控件的使用，可用于文章展示。

技术要点： 

1. 展示本地的String类型html文本。
2. 处理展示的文本的样式 。
   3. 如何获知并处理用户的进一步操作。
   4. 挑战任务：如何获取用户选中的文本段，并向其中==即时添加==样式（下划虚线，点击控件）。如何获取评论，保存评论，展示评论。【⭐⭐⭐⭐⭐】

解决方案：

1. 向html中插入HTML头以及解析标签<html>, <body>, 通过WebView中的loadDataWithBaseURL(null, ``content``, “text/html”, “utf-8”, null )可展示。（已尝试）

2. 直接在WebView中展示原生HTML样式。

### 会议

1. RSS更新（定时更新/下拉刷新）：比较RSS的推送时间
2. 将ArticleBrife的pubDate对外封闭，用于排序。
3.  Article的查询应按照id的降序，插入时间的升序。
4.  数据库类的对象应有默认值。



## 4.26

数据库更新：addChannel方法用更新的方式，对4.25会议提出的议题更新了新的数据成员和对外接口。

工作进展：学习WebView与JS代码之间的互动。

####会议

WebView，拦截资源加载本地缓存图片

了解并使用==MVP架构==  

跨进程通信，通过Service在进程间传递数据，传输大数据

   

## 4.27

- MVP架构

  - Model（模型层）、View（视图层）、Presenter（主持者）

  - Contact（契约、待实现的功能）、View（管理UI，提供UI的变动接口，接收并提交用户事件）、Model（数据实体，管理数据，提供数据的存取接口，提供回调的接口）、Presenter（处理事件，调用数据，变更UI）。

  - 不直接持有类对象而持有接口对象，凡是实现了 Presenter接口 便是 Presenter 层，凡是实现了 View接口 便是 View 层。
  - Presenter层对Model层的实现类持有直接对象。

- 文章显示包的设计 showarticle
  - ShowArticleActivity：统筹视图和管理者
  - ShowArticleContract：接口定义
  - ShowArticleFragment：View层
  - ShowArticlePresenter：Presenter层
  - ShowArticleRes：实现功能用到的资源类和数据集合

## 4.28

- 设计ShowArticleWebView类，应实现接口WebView
  - WebView中包括
    - 初始化配置
    - 展示文章内容
    - 获取选中内容
    - 更改文字大小
    - 更改文字间距
    - 更改文字颜色
    - 内容分享
- 完成更改文字大小、间距、颜色。
- 初始化：支持使用JS、禁止缩放、支持在原控件上打开新页面。

## 4.30

- 数据库返工
  - Channel中的image不能使用byte[]，原因是LitePal未对数组类型的进行处理，解决方案：将byte[]转String存储。传入byte[]参数，转为String类型存储，取出时转为byte[]提交。
  - ArticleBrief和Collection中的category不能使用String[]，原因同上，解决方案：将String[]组合成String存储。传入String[]参数，以“,”作为分隔符组合成String，取出时按分隔符分割成String[]提交。
- ==数据库类被shu弄脏了！！！==

## 5.1

- 获取用户选中内容

  - 动态改变，应该在点击提交按钮时才最终提交

  ```java
  /**
       * 获取选中内容
       *
       * @param callBack 返回选中内容的回调对象
       */
      public void getSelectedData(final ShowArticleContract.getSelectedDataCallBack callBack){
          //在WebView中插入JavaScript代码并设定返回值的回调CallBack
          this.evaluateJavascript(this.js.getGetSelectedJs(), new ValueCallback<String>() {
              @Override
              public void onReceiveValue(String text) {
                  //去除文本中的换行符
                  text.replace("\n", "");
                  //回调传递JS获得的内容
                  callBack.onReceiveData(text);
              }
          });
      }
  
      /**
       * 在用户选中文本时，显示出自定义的ActionMode对象
       *
       * @param actionMode 系统原ActionMode
       * @param actionList 封装的自定义列表
       * @param listener   ActionMode被点击的监听器，用于回调返回选中的内容和点击的按钮标题
       * @return 重新封装的自定义ActionMode
       */
      public ActionMode getActionMode(final ActionMode actionMode,
                                      List<String> actionList,
                                      final ShowArticleContract.onActionClickListener listener){
          if(actionMode != null){
              //清空原菜单
              final Menu menu = actionMode.getMenu();
              menu.clear();
              //加入自定义的菜单
              for(String s:actionList) menu.add(s);
              //设置点击事件
              for(int i = 0; i < menu.size(); i++){
                  MenuItem item = menu.getItem(i);
                      item.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
                          @Override
                          public boolean onMenuItemClick(MenuItem menuItem) {
                              //获取标题
                              final String title = menuItem.getTitle().toString();
                              getSelectedData(new ShowArticleContract.getSelectedDataCallBack() {
                                  @Override
                                  public void onReceiveData(String data) {
                                      actionMode.finish();
                                      //回调获取按钮的标题以及选中的内容
                                      listener.onActionClick(title, data);
                                  }
                              });
                              return true;
                          }
                      });
              }
          }
          return actionMode;
      }
  ```

- 拦截并更改WebView的ActionMode

  - 新弹出的窗口：复制，评论（，分享，...）

  - 使用方法：

    ```java
    	//在Activity类中重载以下函数
        @Override
        public void onActionModeStarted(android.view.ActionMode mode) {
            //拦截并更改ActionMode中的Menu清单
            List<String> actionList  = new ArrayList<>();
            mode = showArticleWebView.getActionMode(mode, actionList, 
                    new ShowArticleContract.onActionClickListener(){
                @Override
                public void onActionClick(String title, String text) {
                    //处理点击事件的逻辑
                    Log.d("SelectedDataTest", "onActionClick: title: " + title +", text: " + text);
                }
            });
            //提交到父类的对应方法中处理
            super.onActionModeStarted(mode);
        }
    ```



## 5.2

- 截取WebView页面长图

  - 通过画布Canvas在Bitmap上写内容

  ```java
  //获得网页长图
  public Bitmap getPicture(){
      //设定尺寸布局
    //public final void measure(int widthMeasureSpec, int heightMeasureSpec)
      this.measure(MeasureSpec.makeMeasureSpec(MeasureSpec.UNSPECIFIED, MeasureSpec.UNSPECIFIED),
              MeasureSpec.makeMeasureSpec(0, MeasureSpec.UNSPECIFIED));
      this.layout(0, 0, this.getMeasuredWidth(), this.getMeasuredHeight());
      //创建Bitmap对象承载图象，尺寸应与WebView内容一致
      Bitmap longImage = Bitmap.createBitmap(this.getMeasuredWidth(),
              this.getMeasuredHeight(), Bitmap.Config.ARGB_8888);
      //创建Canvas对象作为作图工具
      Canvas canvas = new Canvas(longImage);
      Paint paint = new Paint();
      canvas.drawBitmap(longImage, 0, this.getMeasuredHeight(), paint);
      //调用WebView的方法将内容输出到画布上
      this.draw(canvas);
      return longImage;
  }
  ```

## 5.3

- 修整代码，封装到同一个类中，打上注释
- todo? - 文章展示时添加标题和作者等资料

## 5.4

- ActionMode点击按钮后消失
- 文章展示时标题和作者不放在WebView中展示
- 数据库增加本地评论，局部评论
- todo - ArticleBrief里的首张图片截取
- todo - 添加全局评论表，局部评论表

## 5.5

